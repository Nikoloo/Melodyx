<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Connexion en cours - Melodyx</title>
    <link rel="stylesheet" href="../../src/css/base/main.css">
    <style>
        .callback-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--background-dark);
            text-align: center;
        }
        
        .callback-content {
            max-width: 500px;
            padding: 3rem 2rem;
            background: var(--background-card);
            border-radius: var(--border-radius);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: var(--shadow);
        }
        
        .callback-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(29, 185, 84, 0.3);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 2rem;
        }
        
        .callback-title {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 1rem;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .callback-description {
            color: var(--text-secondary);
            line-height: 1.6;
            margin-bottom: 2rem;
        }
        
        .callback-error {
            color: var(--accent-color);
            background: rgba(255, 107, 107, 0.1);
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid rgba(255, 107, 107, 0.3);
            margin-bottom: 2rem;
        }
        
        .callback-success {
            color: var(--primary-color);
            background: rgba(29, 185, 84, 0.1);
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid rgba(29, 185, 84, 0.3);
            margin-bottom: 2rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="callback-container">
        <div class="callback-content">
            <div class="callback-spinner"></div>
            <h1 class="callback-title">Connexion en cours...</h1>
            <p class="callback-description">
                Nous finalisons votre connexion avec Spotify. 
                Vous serez automatiquement redirigé vers l'application.
            </p>
            <div id="callback-message"></div>
            <button id="manual-redirect" class="btn btn-primary" style="display: none;">
                Continuer vers l'application
            </button>
        </div>
    </div>

    <script src="../js/auth/config.js"></script>
    <script src="../js/auth/spotify-auth.js"></script>
    <script>
        // Gérer le processus de callback
        document.addEventListener('DOMContentLoaded', async () => {
            const messageDiv = document.getElementById('callback-message');
            const manualRedirectBtn = document.getElementById('manual-redirect');
            const spinner = document.querySelector('.callback-spinner');
            const title = document.querySelector('.callback-title');
            const description = document.querySelector('.callback-description');

            try {
                // Vérifier s'il y a des paramètres d'URL
                const urlParams = new URLSearchParams(window.location.search);
                const code = urlParams.get('code');
                const error = urlParams.get('error');
                const state = urlParams.get('state');

                if (error) {
                    throw new Error(`Erreur d'autorisation: ${error}`);
                }

                if (!code) {
                    throw new Error('Code d\'autorisation manquant');
                }

                // Vérifier le state pour la sécurité
                const savedState = localStorage.getItem('spotify_state');
                if (state !== savedState) {
                    throw new Error('Erreur de sécurité: state invalide');
                }

                // Échanger le code contre un token
                await SpotifyAuth.exchangeCodeForToken(code);

                // Succès
                spinner.style.display = 'none';
                title.textContent = 'Connexion réussie !';
                description.textContent = 'Redirection vers l\'application...';
                
                messageDiv.innerHTML = '<div class="callback-success">✓ Vous êtes maintenant connecté à Spotify !</div>';
                
                // Redirection automatique après 2 secondes
                setTimeout(() => {
                    window.location.href = './app.html';
                }, 2000);

                // Bouton de redirection manuelle au cas où
                setTimeout(() => {
                    manualRedirectBtn.style.display = 'inline-flex';
                    manualRedirectBtn.addEventListener('click', () => {
                        window.location.href = './app.html';
                    });
                }, 5000);

            } catch (error) {
                console.error('Erreur de callback:', error);
                
                spinner.style.display = 'none';
                title.textContent = 'Erreur de connexion';
                description.textContent = 'Une erreur est survenue lors de la connexion à Spotify.';
                
                messageDiv.innerHTML = `<div class="callback-error">${error.message}</div>`;
                
                // Bouton pour retourner à l'accueil
                manualRedirectBtn.textContent = 'Retour à l\'accueil';
                manualRedirectBtn.style.display = 'inline-flex';
                manualRedirectBtn.addEventListener('click', () => {
                    // Nettoyer le localStorage
                    localStorage.removeItem('spotify_code_verifier');
                    localStorage.removeItem('spotify_state');
                    // Rediriger vers la racine du site
                    const basePath = window.location.pathname.split('/src/')[0];
                    window.location.href = basePath + '/';
                });
            }
        });
    </script>
</body>
</html>