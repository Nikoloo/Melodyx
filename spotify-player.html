<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spotify Player | Melodyx</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="spotify-player.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="page-container">
        <a href="app.html" class="back-button" title="Retour">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
            </svg>
        </a>
        
        <div class="header-actions">
            <button id="search-btn" class="header-action-btn" title="Rechercher de la musique">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
                </svg>
            </button>
            <button id="playlist-btn" class="header-action-btn" title="Mes playlists">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M15 6H3v2h12V6zm0 4H3v2h12v-2zM3 16h8v-2H3v2zM17 6v8.18c-.31-.11-.65-.18-1-.18-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3V8h3V6h-5z"/>
                </svg>
            </button>
        </div>
        
        <div class="player-content">
            <!-- Status de connexion -->
            <div id="connection-status" class="connection-status">
                <div class="loading-spinner">
                    <div class="spinner"></div>
                </div>
                <h3>Initialisation du lecteur...</h3>
                <p>Connexion au service Spotify</p>
            </div>
            
            <!-- Interface principale du lecteur -->
            <div id="player-interface" class="player-interface" style="display: none;">
                <!-- Informations de la piste actuelle -->
                <div class="track-info">
                    <div class="track-artwork">
                        <img id="track-image" src="" alt="Album artwork" />
                        <div class="track-placeholder">üéµ</div>
                    </div>
                    <div class="track-details">
                        <h2 id="track-name">Aucune piste en lecture</h2>
                        <p id="track-artist">S√©lectionnez une piste pour commencer</p>
                        <p id="track-album"></p>
                    </div>
                </div>
                
                <!-- Barre de progression -->
                <div class="progress-section">
                    <span id="current-time">0:00</span>
                    <div class="progress-bar">
                        <div class="progress-track">
                            <div id="progress-fill" class="progress-fill"></div>
                        </div>
                        <input type="range" id="progress-slider" min="0" max="100" value="0" class="progress-input">
                    </div>
                    <span id="total-time">0:00</span>
                </div>
                
                <!-- Contr√¥les de lecture -->
                <div class="playback-controls">
                    <button id="prev-btn" class="control-btn" title="Pr√©c√©dent" disabled>
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M6 6h2v12H6V6zm3.5 6l8.5 6V6l-8.5 6z"/>
                        </svg>
                        <div class="control-loading" style="display: none;"></div>
                    </button>
                    
                    <button id="play-pause-btn" class="control-btn play-btn" title="Lecture" disabled>
                        <svg id="play-icon" width="32" height="32" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M8 5v14l11-7z"/>
                        </svg>
                        <svg id="pause-icon" width="32" height="32" viewBox="0 0 24 24" fill="currentColor" style="display: none;">
                            <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>
                        </svg>
                        <div class="control-loading" style="display: none;"></div>
                    </button>
                    
                    <button id="next-btn" class="control-btn" title="Suivant" disabled>
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/>
                        </svg>
                        <div class="control-loading" style="display: none;"></div>
                    </button>
                </div>
                
                <!-- Queue and Volume Controls -->
                <div class="media-controls">
                    <button id="queue-btn" class="media-control-btn" title="Liste d'attente">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M4 6h16v2H4zm0 5h16v2H4zm0 5h16v2H4z"/>
                        </svg>
                    </button>
                    
                    <div class="horizontal-volume-control">
                        <div class="volume-icon" id="volume-btn">
                            <i class="fas fa-volume-up" id="volume-icon"></i>
                        </div>
                        <div class="volume-slider-container">
                            <input type="range" id="volume-input" min="0" max="100" value="50" class="horizontal-volume-slider">
                        </div>
                    </div>
                </div>
                
                <!-- Device Actions (without status display) -->
                <div class="device-actions-only">
                    <div id="device-actions" class="device-actions" style="display: none;">
                        <button id="transfer-here-btn" class="btn btn-sm btn-primary">Transf√©rer ici</button>
                        <button id="refresh-state-btn" class="btn btn-sm btn-secondary">Actualiser</button>
                    </div>
                </div>
            </div>
            
            <!-- Message d'erreur -->
            <div id="error-message" class="error-message" style="display: none;">
                <div class="error-icon">‚ö†Ô∏è</div>
                <h3>Erreur de connexion</h3>
                <p id="error-text">Une erreur s'est produite lors de la connexion au service Spotify.</p>
                <button id="retry-btn" class="btn btn-primary">R√©essayer</button>
            </div>
            
            <!-- Instructions Premium -->
            <div id="premium-notice" class="premium-notice" style="display: none;">
                <div class="premium-icon">‚≠ê</div>
                <h3>Spotify Premium requis</h3>
                <p>Pour utiliser le lecteur int√©gr√©, vous devez avoir un abonnement Spotify Premium actif.</p>
                <div class="premium-features">
                    <span>‚úì Lecture haute qualit√©</span>
                    <span>‚úì Contr√¥le total</span>
                    <span>‚úì Sans publicit√©</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Search Modal -->
    <div id="search-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content search-modal">
            <div class="modal-header">
                <h3>Rechercher de la musique</h3>
                <button id="search-close-btn" class="modal-close-btn" title="Fermer">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                    </svg>
                </button>
            </div>
            <div class="search-input-container">
                <svg class="search-input-icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
                </svg>
                <input type="text" id="search-input" placeholder="Rechercher des titres, artistes, albums..." autocomplete="off">
                <button id="search-clear-btn" class="search-clear-btn" style="display: none;" title="Effacer">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                    </svg>
                </button>
            </div>
            <div class="search-filters">
                <button class="search-filter active" data-type="track">Titres</button>
                <button class="search-filter" data-type="artist">Artistes</button>
                <button class="search-filter" data-type="album">Albums</button>
                <button class="search-filter" data-type="playlist">Playlists</button>
            </div>
            <div id="search-results" class="search-results">
                <div class="search-placeholder">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="currentColor" opacity="0.3">
                        <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
                    </svg>
                    <p>Commencez √† taper pour rechercher</p>
                </div>
                <div id="search-loading" class="search-loading" style="display: none;">
                    <div class="spinner"></div>
                    <p>Recherche en cours...</p>
                </div>
                <div id="search-results-list" class="search-results-list"></div>
            </div>
        </div>
    </div>

    <!-- Playlist Modal -->
    <div id="playlist-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content playlist-modal">
            <div class="modal-header">
                <h3>Mes playlists</h3>
                <button id="playlist-close-btn" class="modal-close-btn" title="Fermer">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                    </svg>
                </button>
            </div>
            <div class="playlist-search-container">
                <svg class="search-input-icon" width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
                </svg>
                <input type="text" id="playlist-search-input" placeholder="Rechercher dans mes playlists..." autocomplete="off">
            </div>
            <div class="playlist-sort-controls">
                <span class="sort-label">Trier par:</span>
                <select id="playlist-sort-select" class="sort-dropdown">
                    <option value="alphabetical">Ordre alphab√©tique</option>
                    <option value="track-count">Nombre de pistes</option>
                </select>
            </div>
            <div id="playlist-results" class="playlist-results">
                <div id="playlist-loading" class="playlist-loading">
                    <div class="spinner"></div>
                    <p>Chargement des playlists...</p>
                </div>
                <div id="playlist-list" class="playlist-list"></div>
            </div>
        </div>
    </div>

    <!-- Queue Modal -->
    <div id="queue-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content queue-modal">
            <div class="modal-header">
                <h3>Liste d'attente</h3>
                <button id="queue-close-btn" class="modal-close-btn" title="Fermer">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                    </svg>
                </button>
            </div>
            <div id="queue-results" class="queue-results">
                <div id="queue-loading" class="queue-loading">
                    <div class="spinner"></div>
                    <p>Chargement de la liste d'attente...</p>
                </div>
                <div id="queue-list" class="queue-list"></div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://sdk.scdn.co/spotify-player.js"></script>
    <script src="spotify-auth.js"></script>
    <script src="spotify-web-api-service.js"></script>
    <script src="spotify-player.js"></script>
    <script>
        // V√©rifier l'authentification au chargement
        document.addEventListener('DOMContentLoaded', async () => {
            if (!SpotifyAuth.isLoggedIn()) {
                // Rediriger vers la page d'accueil si pas connect√©
                window.location.href = '/Melodyx/';
                return;
            }

            // Initialiser le lecteur Spotify
            await initializeSpotifyPlayer();
        });

        // Fonction pour initialiser le lecteur
        async function initializeSpotifyPlayer() {
            try {
                logger.info('HTML: Initialisation du lecteur Spotify');
                
                // Cr√©er l'instance globale
                window.spotifyPlayer = new SpotifyPlayer();
                await window.spotifyPlayer.initialize();
                
                logger.info('HTML: Lecteur initialis√© avec succ√®s');
            } catch (error) {
                logger.error('HTML: Erreur lors de l\'initialisation', error);
                showError(error.message || 'Impossible d\'initialiser le lecteur Spotify');
            }
        }

        // Fonction pour afficher les erreurs
        function showError(message) {
            const statusDiv = document.getElementById('connection-status');
            const errorDiv = document.getElementById('error-message');
            const errorText = document.getElementById('error-text');
            
            statusDiv.style.display = 'none';
            errorText.textContent = message;
            errorDiv.style.display = 'block';
        }
    </script>
</body>
</html>